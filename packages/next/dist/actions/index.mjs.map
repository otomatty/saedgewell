{"version":3,"sources":["../../src/actions/index.ts"],"names":[],"mappings":";;;;;;AAkBO,SAAS,aAAA,CAYd,IAIA,MACA,EAAA;AACA,EAAA,OAAO,OACL,MACG,KAAA;AAtCP,IAAA,IAAA,EAAA,EAAA,EAAA;AAyCI,IAAM,MAAA,WAAA,GAAA,CAAc,EAAO,GAAA,MAAA,CAAA,IAAA,KAAP,IAAe,GAAA,EAAA,GAAA,IAAA;AACnC,IAAA,IAAI,IAAkB,GAAA,MAAA;AAGtB,IAAM,MAAA,IAAA,GAAO,OAAO,MAChB,GAAA,eAAA,CAAgB,OAAO,MAAM,CAAA,CAAE,MAAM,CACrC,GAAA,MAAA;AAGJ,IAAM,MAAA,aAAA,GAAA,CAAgB,EAAO,GAAA,MAAA,CAAA,OAAA,KAAP,IAAkB,GAAA,EAAA,GAAA,KAAA;AAGxC,IAAA,IAAI,aAAe,EAAA;AACjB,MAAA,MAAM,QAAS,IAAyC,CAAA,YAAA;AAGxD,MAAA,MAAM,mBAAmB,KAAK,CAAA;AAAA;AAIhC,IAAA,IAAI,WAAa,EAAA;AAEf,MAAA,MAAM,IAAO,GAAA,MAAM,WAAY,CAAA,uBAAA,EAAyB,CAAA;AAGxD,MAAI,IAAA,CAAC,KAAK,IAAM,EAAA;AACd,QAAA,QAAA,CAAS,KAAK,UAAU,CAAA;AAAA;AAG1B,MAAA,IAAA,GAAO,IAAK,CAAA,IAAA;AAAA;AAGd,IAAO,OAAA,EAAA,CAAG,MAAM,IAAI,CAAA;AAAA,GACtB;AACF","file":"index.mjs","sourcesContent":["import 'server-only';\n\nimport { redirect } from 'next/navigation';\n\nimport type { User } from '@supabase/supabase-js';\n\nimport type { ZodType, z } from 'zod';\n\nimport { verifyCaptchaToken } from '@kit/auth/captcha/server';\nimport { requireUser } from '@kit/supabase/require-user';\nimport { getSupabaseServerClient } from '@kit/supabase/server-client';\n\nimport { zodParseFactory } from '../utils';\n\n/**\n * @name enhanceAction\n * @description Enhance an action with captcha, schema and auth checks\n */\nexport function enhanceAction<\n  Args,\n  Response,\n  Config extends {\n    auth?: boolean;\n    captcha?: boolean;\n    schema?: z.ZodType<\n      Config['captcha'] extends true ? Args & { captchaToken: string } : Args,\n      z.ZodTypeDef\n    >;\n  },\n>(\n  fn: (\n    params: Config['schema'] extends ZodType ? z.infer<Config['schema']> : Args,\n    user: Config['auth'] extends false ? undefined : User\n  ) => Response | Promise<Response>,\n  config: Config\n) {\n  return async (\n    params: Config['schema'] extends ZodType ? z.infer<Config['schema']> : Args\n  ) => {\n    type UserParam = Config['auth'] extends false ? undefined : User;\n\n    const requireAuth = config.auth ?? true;\n    let user: UserParam = undefined as UserParam;\n\n    // validate the schema passed in the config if it exists\n    const data = config.schema\n      ? zodParseFactory(config.schema)(params)\n      : params;\n\n    // by default, the CAPTCHA token is not required\n    const verifyCaptcha = config.captcha ?? false;\n\n    // verify the CAPTCHA token. It will throw an error if the token is invalid.\n    if (verifyCaptcha) {\n      const token = (data as Args & { captchaToken: string }).captchaToken;\n\n      // Verify the CAPTCHA token. It will throw an error if the token is invalid.\n      await verifyCaptchaToken(token);\n    }\n\n    // verify the user is authenticated if required\n    if (requireAuth) {\n      // verify the user is authenticated if required\n      const auth = await requireUser(getSupabaseServerClient());\n\n      // If the user is not authenticated, redirect to the specified URL.\n      if (!auth.data) {\n        redirect(auth.redirectTo);\n      }\n\n      user = auth.data as UserParam;\n    }\n\n    return fn(data, user);\n  };\n}\n"]}